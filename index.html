<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>3D Generátor Prsteňov</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/STLExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        #3d-viewer {
            width: 400px;
            height: 400px;
            border: 1px solid #ccc;
            background-color: #fff;
            margin-top: 20px;
        }
        input, button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
        }
        button {
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #message {
            margin-top: 10px;
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>
    <label for="ringSize">Veľkosť prsteňa:</label>
    <input type="number" id="ringSize" min="42" max="70" value="52">
    <button id="generateButton">Generovať prsteň</button>
    <div id="message"></div>
    <div id="3d-viewer"></div>
    <button id="downloadButton">Stiahnuť STL</button>

    <script>
        let ring;
        const ringSize = 52;

        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('3d-viewer').appendChild(renderer.domElement);

        const scene = new THREE.Scene();

        const camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000 
        );
        camera.position.set(0, 2, 10);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.update();

        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);

        const spotLightIntensity = 0.5;
        const spotLightDistance = 20;
        const spotLightColor = 0xffffff;
        const numberOfLights = 8;

        for (let i = 0; i < numberOfLights; i++) {
            const angle = (i / numberOfLights) * Math.PI * 2;
            const x = Math.cos(angle) * spotLightDistance;
            const z = Math.sin(angle) * spotLightDistance;

            const spotLight = new THREE.SpotLight(spotLightColor, spotLightIntensity);
            spotLight.position.set(x, 20, z);
            spotLight.lookAt(new THREE.Vector3(0, 0, 0));
            spotLight.castShadow = true;

            scene.add(spotLight);
        }

        function generateRing() {
            const size = document.getElementById('ringSize').value;
            const radius = size / (2 * Math.PI);
            let geometry;

            if (ring) {
                scene.remove(ring);
            }

            const width = Math.random() * (4.5 - 2) + 2;
            const thickness = Math.random() * (1.8 - 1.5) + 1.5;
            const rounding = 0.15;

            const shape = new THREE.Shape();
            const halfWidth = width / 2;

            // Vytvorenie prsteňa so zaoblenými rohmi
            shape.moveTo(radius, -halfWidth);
            shape.lineTo(radius, halfWidth);
            shape.quadraticCurveTo(radius, halfWidth + rounding, radius + rounding, halfWidth + rounding);
            shape.lineTo(radius + thickness - rounding, halfWidth + rounding);
            shape.quadraticCurveTo(radius + thickness, halfWidth + rounding, radius + thickness, halfWidth);
            shape.lineTo(radius + thickness, -halfWidth);
            shape.quadraticCurveTo(radius + thickness, -halfWidth - rounding, radius + thickness - rounding, -halfWidth - rounding);
            shape.lineTo(radius + rounding, -halfWidth - rounding);
            shape.quadraticCurveTo(radius, -halfWidth - rounding, radius, -halfWidth);

            // Zabezpečenie uzavretia tvaru
            shape.closePath();

            const points = shape.getPoints();
            geometry = new THREE.LatheGeometry(points, 100);

            // Vytvorenie uzavretých viek na oboch koncoch
            const capGeometry1 = new THREE.CircleGeometry(radius, 100);
            const capGeometry2 = new THREE.CircleGeometry(radius + thickness, 100);
            capGeometry1.translate(0, halfWidth, 0);
            capGeometry2.translate(0, -halfWidth, 0);

            const latheBufferGeometry = new THREE.BufferGeometry().fromGeometry(geometry);
            const capBufferGeometry1 = new THREE.BufferGeometry().fromGeometry(capGeometry1);
            const capBufferGeometry2 = new THREE.BufferGeometry().fromGeometry(capGeometry2);

            const mergedGeometry = THREE.BufferGeometryUtils.mergeBufferGeometries([latheBufferGeometry, capBufferGeometry1, capBufferGeometry2]);

            const material = new THREE.MeshPhongMaterial({ 
                color: 0xFFD700,
                shininess: 100,
                reflectivity: 0.9
            });

            ring = new THREE.Mesh(mergedGeometry, material);
            scene.add(ring);

            document.getElementById('message').innerHTML = `
                Vygeneroval sa Ti prsteň veľkosti: ${size} mm<br>
                Výška prsteňa je: ${width.toFixed(2)} mm<br>
                Síla: ${thickness.toFixed(2)} mm<br>
                Zaoblenie: ${rounding} mm
            `;
        }

        function downloadSTL() {
            if (!ring) return;

            // Zafixovanie rotácie a posunutie prsteňa pred exportom
            ring.rotation.set(Math.PI / 2, 0, 0);
            const box = new THREE.Box3().setFromObject(ring);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());

            // Nastavíme prsteň tak, aby ležal na podložke
            ring.position.x = -center.x;
            ring.position.y = -center.y + size.y / 2;
            ring.position.z = -center.z;

            const exporter = new THREE.STLExporter();
            const stlString = exporter.parse(ring);
            const blob = new Blob([stlString], { type: 'application/octet-stream' });
            const link = document.createElement('a');
            const ringSize = document.getElementById('ringSize').value;
            link.href = URL.createObjectURL(blob);
            link.download = `ring_${ringSize}.stl`;
            link.click();
        }

        function animate(time) {
            if (ring) {
                ring.rotation.x = time / 2000;
                ring.rotation.y = time / 1000;
            }
            controls.update();
            renderer.render(scene, camera);
        }

        function init() {
            renderer.setAnimationLoop(animate);
        }

        document.getElementById('generateButton').addEventListener('click', generateRing);
        document.getElementById('downloadButton').addEventListener('click', downloadSTL);

        init();
    </script>
</body>
</html>
